
# HOLT'S WINTERS MODEL
# --------------------->

library(forecast)
library(TTR)
library(ggplot2)


# Model for Forecasting Furniture retail sales

# Seasonally Adjusted data
furniture <- c(4254,4342,4330,4359,4331,4401,4368,4372,4345,4299,4368,4428,4637,4507,4463,4564,4642,4609,4640,4645,4640,4663,4693,4693,4571,4775,4910,4916,4971,5018,5046,5165,5177,5260,5199,5254,5265,5081,5130,5181,5216,5217,5318,5304,5407,5429,5516,5445,5302,5346,5566,5595,5586,5678,5696,5655,5762,5779,5768,5746,5823,5847,5916,5968,6004,6034,6039,6146,6162,6154,6267,6290,6377,6342,6340,6369,6359,6426,6447,6444,6419,6504,6666,6687,6617,6767,6831,6794,6884,6986,6954,7147,7292,7324,7272,7246,7484,7548,7599,7729,7673,7593,7748,7682,7665,7737,7580,7160,7764,7611,7549,7560,7559,7613,7671,7628,7419,7543,7694,7869,7847,7932,7936,7874,7959,7831,7741,7837,7832,7789,7963,7927,7824,7501,7854,7895,8062,8084,8115,8156,8214,8244,8358,8312,8307,8375,8585,8519,8389,8572,8868,8675,8604,8806,8722,8905,8856,8908,8840,8994,8963,9093,9084,9193,9244,9315,9319,9260,9561,9439,9431,9402,9368,9485,9442,9422,9549,9375,9311,9334,9609,9369,9406,9430,9331,9264,9315,9300,9141,9142,9094,9009,8873,8594,8631,8606,8587,8473,8369,8154,7722,7735,7640,7460,7363,7285,7041,7067,7087,7092,7039,6991,6981,6915,6991,7024,7011,7123,7235,7121,7117,7072,7094,7130,7108,7039,7104,7062,6992,7145,7397,7321,7245,7227,7263,7333,7384,7303,7385,7530,7637,7627,7587,7510,7645,7552,7650,7600,7614,7416,7641,7959,7906,7850,7851,7814,7733,7956,7937,7982,8041,8140,8202,7913,7751,8048,8186,8297,8276,8287,8312,8447,8396,8407,8524,8656,8619,8424,8677,8788,8965,8796,8940,8977,8958,9036,9036,9227,9093,9134,9085,9068,9116,9262,9194,9172,9376,9225,9186,9111,9307,9322,9373,9266,9329,9381,9347,9420,9368,9614,9719,9723,9619,9686,9753,9941,9802,9810,9848,9732,9729,9739,9706,9660,9535,9651,9787,9853,9843,9854,9855,9881,9999,9916,9937,9746,10139,10133,7897,4034,7224)

furniture_sale <- ts(furniture, start=c(1992, 1), frequency = 12)
furniture_sale
plot(furniture_sale)

# Not Seasonally Adjusted data
furniture <- c(3846,3908,4157,4141,4275,4357,4407,4446,4328,4497,4687,5287,4104,3908,4369,4372,4535,4568,4682,4733,4621,4775,5158,5631,4018,4140,4827,4700,4867,4958,4980,5356,5203,5328,5734,6305,4649,4410,5084,4818,5195,5196,5190,5506,5418,5505,6090,6409,4788,4833,5410,5310,5603,5479,5673,5893,5589,5970,6425,6734,5311,5116,5715,5670,6010,5805,6027,6263,6094,6369,6781,7554,5822,5581,6162,6038,6225,6310,6466,6502,6329,6693,7186,8098,5922,5996,6790,6481,6684,6853,6961,7240,7139,7339,8006,8883,6638,6989,7622,7134,7635,7487,7508,7974,7535,7667,8346,8635,7050,6797,7572,6940,7551,7491,7456,7971,7078,7603,8548,9427,7149,7091,7777,7370,7991,7502,7671,8205,7456,7859,8839,9528,7190,6713,7618,7374,8078,7753,8074,8384,8017,8351,9018,10166,7651,7613,8499,7991,8112,8443,8895,8883,8441,8718,9594,10917,7908,7973,8787,8418,8649,8966,8957,9607,9216,9110,10232,11297,8595,8457,9412,8556,9209,9447,9244,9940,9511,9178,10195,11051,8802,8423,9415,8553,9266,9171,9194,9867,8885,9069,10012,10487,8163,8104,8381,8029,8604,8117,8495,8456,7676,7712,8121,8862,6796,6593,6907,6608,6974,6922,7194,7159,6967,6853,7375,8401,6324,6468,7271,6729,6932,6902,7243,7330,7101,6793,7630,8482,6244,6488,7530,6896,7086,7039,7241,7685,7450,6967,7931,9029,6866,7169,7784,6872,7683,7378,7551,8064,7439,7260,8260,9216,7297,7089,7875,7314,7834,7558,7977,8461,7848,8059,8842,9195,7201,7227,8104,7791,8384,7881,8403,8734,8371,8441,8950,10231,7964,7514,8616,8261,8893,8576,9110,9148,8967,9108,9488,10925,8175,8376,9258,8596,8988,9095,9157,9539,9498,9013,9903,10806,8255,8222,9626,8562,9394,9334,9207,9825,9471,9441,10487,11211,8686,8504,10016,9205,9949,9751,9740,10209,9573,9758,10579,10925,8648,8445,9846,9360,10069,9539,9944,10345,9839,9995,10782,11003,9257,9191,7881,3865,7202)

furniture_sale <- ts(furniture, start=c(1992, 1), frequency = 12)
furniture_sale <- log(furniture_sale)
furniture_sale
plot(furniture_sale)

# Decompose
retail.decmul <- decompose (furniture_sale, type = "multiplicative")
plot(retail.decmul)

# Seasonally Adjusting
furniture_salecomponents <- decompose(furniture_sale)
furniture_saleseasonallyadjusted <- furniture_sale - furniture_salecomponents$seasonal
plot(furniture_saleseasonallyadjusted)

# Forecasts using Exponential Smoothing
furniture_saleforecast <- HoltWinters(furniture_sale) #(furniture_sale, gamma = FALSE, l.start = 4254, b.start = 88) # 
furniture_saleforecast
furniture_saleforecast$SSE
furniture_saleforecast$fitted
plot(furniture_saleforecast)

#Making the forecast
furniture_saleforecast2 <- forecast:::forecast.HoltWinters(furniture_saleforecast, h=30)
forecast:::plot.forecast(furniture_saleforecast2)
plot.ts(furniture_saleforecast2$residuals)

# checking whether the predictive model could be improved 
acf(furniture_saleforecast2$residuals, lag.max=20, na.action = na.pass)
Box.test(furniture_saleforecast2$residuals, lag=20, type="Ljung-Box")

# Evaluation Metrics
accuracy(furniture_saleforecast2)
tablesales <- data.frame(accuracy(furniture_saleforecast2))
View(tablesales)

# Visualize the MAIN evaluation Metrics
furniture_metrics <- data.frame(Metric = c("MAE", "RMSE"), Values = c((tablesales$MAE),(tablesales$RMSE)))
furniture_metrics
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=furniture_metrics, aes(x=Metric, y=Values, fill=Values)) + geom_bar(stat="identity", position=position_dodge())

# Visualize the OTHER evaluation Metrics
furniture_metrics2 <- data.frame(Metric = c("MAPE", "MASE"), Values = c((tablesales$MAPE),(tablesales$MASE)))
furniture_metrics2
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=furniture_metrics2, aes(x=Metric, y=Values, fill=Metric)) + geom_bar(stat="identity", position=position_dodge())

# define an R function "plotForecastErrors()"
plotForecastErrors <- function(forecasterrors)
{
  # make a histogram of the forecast errors:
  mybinsize <- IQR(forecasterrors, na.rm = TRUE)/4
  mysd   <- sd(forecasterrors, na.rm = TRUE)
  mymin  <- min(forecasterrors, na.rm = TRUE) - mysd*5
  mymax  <- max(forecasterrors, na.rm = TRUE) + mysd*3
  # generate normally distributed data with mean 0 and standard deviation mysd
  mynorm <- rnorm(10000, mean=0, sd=mysd)
  mymin2 <- min(mynorm, na.rm = TRUE)
  mymax2 <- max(mynorm, na.rm = TRUE)
  if (mymin2 < mymin ) { mymin <- mymin2}
  if (mymax2 > mymax) { mymax <- mymax2}
  # make a red histogram of the forecast errors, with the normally distributed data overlaid:
  mybins <- seq(mymin, mymax, mybinsize)
  hist(forecasterrors, col="orange", freq=FALSE, breaks=mybins)
  # freq=FALSE ensures the area under the histogram = 1
  # generate normally distributed data with mean 0 and standard deviation mysd
  myhist <- hist(mynorm, plot=FALSE, breaks=mybins)
  # plot the normal curve as a blue line on top of the histogram of forecast errors:
  points(myhist$mids, myhist$density, type="l", col="blue", lwd=2)
}

# Histgoram of forecast errors
plotForecastErrors(furniture_saleforecast2$residuals)


# Evaluation Metrics for actual value (back-tranformed log values)
library(Metrics)

actlfurn <- data.frame(furniture_sale)
View(actlfurn)
library(Metrics)
predsale <- data.frame(furniture_saleforecast$fitted)
predsale1 <- predsale$xhat
View(predsale1)
# back-tranform log values to original scale
predsale2 <- exp(predsale1)
View(predsale2)

actlfurn2 <- c(8.319717,8.270781,8.382289,8.382976,8.419580,8.426831,8.451481,8.462315,8.438366,8.471149,8.548304,8.636042,8.298540,8.328451,8.481980,8.455318,8.490233,8.508758,8.513185,8.585973,8.556991,8.580731,8.654169,8.749098,8.444407,8.391630,8.533854,8.480114,8.555452,8.555644,8.554489,8.613594,8.597482,8.613412,8.714403,8.765459,8.473868,8.483223,8.596004,8.577347,8.631057,8.608678,8.643473,8.681520,8.628556,8.694502,8.767952,8.814925,8.577535,8.540128,8.650850,8.642944,8.701180,8.666475,8.704005,8.742415,8.715060,8.759198,8.821880,8.929833,8.669399,8.627123,8.726157,8.705828,8.736329,8.749891,8.774313,8.779865,8.752898,8.808817,8.879890,8.999372,8.686430,8.698848,8.823206,8.776630,8.807472,8.832442,8.848078,8.887376,8.873328,8.900958,8.987947,9.091895,8.800566,8.852093,8.938794,8.872627,8.940498,8.920923,8.923724,8.983942,8.927314,8.944681,9.029538,9.063579,8.860783,8.824237,8.932213,8.845057,8.929435,8.921458,8.916774,8.983565,8.864747,8.936298,9.053453,9.151333,8.874728,8.866582,8.958926,8.905173,8.986071,8.922925,8.945202,9.012499,8.916774,8.969415,9.086929,9.161990,8.880446,8.811801,8.938269,8.905716,8.996900,8.955835,8.996404,9.034080,8.989320,9.030137,9.106978,9.226804,8.942592,8.937613,9.047704,8.986071,9.001100,9.041093,9.093245,9.091895,9.040856,9.073145,9.168893,9.298076,8.975630,8.983816,9.081029,9.038128,9.065199,9.101195,9.100191,9.170247,9.128696,9.117128,9.233275,9.332292,9.058936,9.042750,9.149741,9.054388,9.127937,9.153453,9.131730,9.204322,9.160204,9.124565,9.229653,9.310276,9.082734,9.038721,9.150059,9.054037,9.134107,9.123802,9.126306,9.196951,9.092120,9.112617,9.211540,9.257892,9.007367,9.000113,9.033723,8.990815,9.059982,9.001716,9.047233,9.042632,8.945854,8.950533,9.002209,9.089528,8.824089,8.793764,8.840291,8.796036,8.849944,8.842460,8.881003,8.876126,8.848940,8.832442,8.905851,9.036106,8.752107,8.774622,8.891649,8.814182,8.843904,8.839567,8.887791,8.899731,8.867991,8.823648,8.939843,9.045702,8.739376,8.777710,8.926650,8.838697,8.865876,8.859221,8.887515,8.947026,8.915969,8.848940,8.978534,9.108197,8.834337,8.877521,8.959826,8.835210,8.946765,8.906258,8.929435,8.995165,8.914492,8.890135,9.019180,9.128696,8.895219,8.866300,8.971448,8.897546,8.966229,8.930362,8.984318,9.043223,8.968014,8.994545,9.087268,9.126415,8.881975,8.885579,9.000113,8.960725,9.034080,8.972210,9.036344,9.074979,9.032529,9.040856,9.099409,9.233178,8.982687,8.924523,9.061376,9.019301,9.093020,9.056723,9.117128,9.121291,9.101306,9.116908,9.157783,9.298809,9.008836,9.033126,9.133243,9.059052,9.103646,9.115480,9.122274,9.163144,9.158837,9.106423,9.200593,9.287857,9.018574,9.014569,9.172223,9.055089,9.147826,9.141419,9.127719,9.192685,9.155990,9.152817,9.257892,9.324651,9.069468,9.048292,9.211939,9.127502,9.205227,9.185125,9.183996,9.231025,9.166702,9.185843,9.266626,9.298809,9.065083,9.041330,9.194821,9.144201,9.217217,9.163144,9.204725,9.244259,9.194109,9.209840,9.285633,9.305923,9.133135,9.125980,8.972210,8.259717,8.882114)
predfurn2 <- c(8.295345,8.258948,8.376309,8.379934,8.416700,8.423922,8.446221,8.460221,8.437501,8.477087,8.515755,8.654191,8.395124,8.293436,8.421995,8.453723,8.489879,8.495930,8.523935,8.529264,8.535509,8.585721,8.630287,8.758558,8.495073,8.434623,8.525825,8.523208,8.535517,8.553214,8.572656,8.582117,8.570354,8.619848,8.666774,8.803131,8.519339,8.462127,8.593219,8.581584,8.622294,8.632207,8.635546,8.664995,8.644974,8.667319,8.738532,8.854765,8.568762,8.548430,8.661941,8.642139,8.687089,8.695865,8.699998,8.728419,8.702974,8.745769,8.810113,8.908515,8.660903,8.638708,8.750514,8.725484,8.761456,8.744160,8.770868,8.800294,8.756398,8.790893,8.857119,8.962273,8.721283,8.673523,8.802975,8.802093,8.834523,8.820170,8.850230,8.873955,8.850287,8.901932,8.959330,9.069824,8.812524,8.784729,8.936463,8.921345,8.941983,8.946628,8.955515,8.965900,8.946138,8.972896,9.019452,9.119087,8.816045,8.827191,8.933074,8.908958,8.926284,8.929250,8.945774,8.962769,8.938963,8.934186,9.000192,9.113558,8.871570,8.854640,8.968257,8.931569,8.976672,8.981503,8.968380,8.994149,8.956969,8.979231,9.045026,9.150205,8.889821,8.866785,8.941614,8.904888,8.967776,8.973857,8.985903,9.034243,8.979860,9.031922,9.108399,9.186980,8.938686,8.917103,9.038486,9.009612,9.063793,9.015883,9.054295,9.116652,9.050815,9.091424,9.159284,9.248772,9.001159,8.966111,9.084527,9.044762,9.102907,9.078995,9.117604,9.142275,9.105932,9.162960,9.219913,9.316370,9.041950,9.034677,9.145562,9.109610,9.138303,9.136095,9.167282,9.187879,9.144620,9.189165,9.243132,9.325214,9.033901,9.041589,9.145561,9.101773,9.139254,9.142579,9.147460,9.181220,9.136707,9.138657,9.218169,9.302774,9.002507,8.979373,9.095355,9.008757,9.065547,9.065444,9.044621,9.093670,9.004583,8.999112,9.066742,9.113424,8.827525,8.799199,8.888353,8.811340,8.868160,8.851315,8.864828,8.911929,8.827533,8.863535,8.936745,9.004675,8.749316,8.723098,8.836363,8.817794,8.880753,8.855533,8.868579,8.911087,8.846913,8.876674,8.938642,9.031502,8.763929,8.729507,8.841597,8.831704,8.896536,8.877575,8.894126,8.919591,8.880250,8.909209,8.974632,9.071109,8.811535,8.811985,8.938940,8.886622,8.916579,8.931796,8.946771,8.971466,8.931822,8.921437,9.010375,9.113991,8.841263,8.863841,8.952357,8.890288,8.961514,8.956862,8.972656,9.018113,8.974706,8.968796,9.093590,9.190941,8.881881,8.869859,8.967406,8.911155,9.004687,9.009765,9.025017,9.072507,9.013721,9.025731,9.141517,9.213201,8.957204,8.961450,9.034167,8.977726,9.065148,9.061746,9.100833,9.150662,9.077793,9.092438,9.206777,9.283126,9.026166,9.000608,9.118389,9.057957,9.122907,9.090838,9.148367,9.170350,9.115724,9.141031,9.215236,9.317622,9.032557,9.014660,9.112729,9.073858,9.125625,9.120701,9.169941,9.185680,9.144671,9.143525,9.243256,9.359415,9.073931,9.063058,9.160985,9.108180,9.185374,9.179462,9.213393,9.242307,9.192520,9.171668,9.274644,9.372728,9.070030,9.057204,9.162187,9.095320,9.187704,9.184821,9.199633,9.248605,9.200483,9.194695,9.295422,9.384437,9.087734,9.100234,9.233587,9.013142,8.675365)
testmae <- mae(actlfurn2,predfurn2)

actlfurn1 <- c(4104,3908,4369,4372,4535,4568,4682,4733,4621,4775,5158,5631,4018,4140,4827,4700,4867,4958,4980,5356,5203,5328,5734,6305,4649,4410,5084,4818,5195,5196,5190,5506,5418,5505,6090,6409,4788,4833,5410,5310,5603,5479,5673,5893,5589,5970,6425,6734,5311,5116,5715,5670,6010,5805,6027,6263,6094,6369,6781,7554,5822,5581,6162,6038,6225,6310,6466,6502,6329,6693,7186,8098,5922,5996,6790,6481,6684,6853,6961,7240,7139,7339,8006,8883,6638,6989,7622,7134,7635,7487,7508,7974,7535,7667,8346,8635,7050,6797,7572,6940,7551,7491,7456,7971,7078,7603,8548,9427,7149,7091,7777,7370,7991,7502,7671,8205,7456,7859,8839,9528,7190,6713,7618,7374,8078,7753,8074,8384,8017,8351,9018,10166,7651,7613,8499,7991,8112,8443,8895,8883,8441,8718,9594,10917,7908,7973,8787,8418,8649,8966,8957,9607,9216,9110,10232,11297,8595,8457,9412,8556,9209,9447,9244,9940,9511,9178,10195,11051,8802,8423,9415,8553,9266,9171,9194,9867,8885,9069,10012,10487,8163,8104,8381,8029,8604,8117,8495,8456,7676,7712,8121,8862,6796,6593,6907,6608,6974,6922,7194,7159,6967,6853,7375,8401,6324,6468,7271,6729,6932,6902,7243,7330,7101,6793,7630,8482,6244,6488,7530,6896,7086,7039,7241,7685,7450,6967,7931,9029,6866,7169,7784,6872,7683,7378,7551,8064,7439,7260,8260,9216,7297,7089,7875,7314,7834,7558,7977,8461,7848,8059,8842,9195,7201,7227,8104,7791,8384,7881,8403,8734,8371,8441,8950,10231,7964,7514,8616,8261,8893,8576,9110,9148,8967,9108,9488,10925,8175,8376,9258,8596,8988,9095,9157,9539,9498,9013,9903,10806,8255,8222,9626,8562,9394,9334,9207,9825,9471,9441,10487,11211,8686,8504,10016,9205,9949,9751,9740,10209,9573,9758,10579,10925,8648,8445,9846,9360,10069,9539,9944,10345,9839,9995,10782,11003,9257,9191,7881,3865,7202)
predfurn1 <- c(4005,3862,4343,4359,4522,4555,4657,4723,4617,4803,4993,5734,4425,3998,4546,4693,4865,4895,5034,5061,5092,5355,5599,6365,4891,4604,5043,5030,5092,5183,5285,5335,5273,5541,5807,6655,5011,4732,5395,5333,5554,5609,5628,5796,5682,5810,6239,7008,5265,5159,5779,5665,5926,5978,6003,6176,6021,6284,6702,7395,5773,5646,6314,6158,6383,6274,6444,6636,6351,6574,7024,7803,6132,5846,6654,6648,6867,6769,6976,7143,6976,7346,7780,8689,6718,6534,7604,7490,7646,7682,7751,7831,7678,7886,8262,9128,6742,6817,7579,7398,7527,7550,7675,7807,7623,7587,8105,9078,7126,7007,7850,7567,7916,7955,7851,8056,7762,7937,8476,9416,7258,7092,7644,7368,7846,7894,7990,8385,7942,8366,9031,9769,7621,7458,8421,8181,8637,8233,8555,9106,8525,8879,9502,10392,8112,7833,8818,8474,8981,8769,9114,9342,9009,9537,10096,11119,8450,8389,9373,9042,9305,9284,9579,9778,9364,9790,10333,11217,8382,8447,9373,8971,9314,9345,9391,9713,9290,9308,10079,10968,8123,7938,8914,8174,8652,8651,8473,8899,8140,8096,8662,9076,6819,6629,7247,6710,7102,6984,7079,7420,6819,7069,7606,8141,6306,6143,6880,6753,7192,7013,7105,7414,6953,7163,7621,8362,6399,6183,6916,6848,7307,7169,7289,7477,7189,7400,7900,8700,6711,6714,7623,7235,7455,7569,7683,7875,7569,7491,8188,9081,6914,7072,7726,7261,7797,7761,7885,8251,7901,7854,8898,9808,7200,7114,7843,7414,8141,8183,8308,8712,8215,8314,9335,10029,7764,7797,8385,7925,8649,8619,8963,9421,8759,8888,9964,10755,8318,8108,9121,8587,9163,8874,9399,9608,9097,9330,10049,11132,8371,8223,9070,8724,9188,9143,9604,9756,9364,9354,10335,11608,8725,8631,9518,9029,9753,9696,10031,10325,9823,9621,10664,11763,8691,8580,9530,8913,9776,9748,9893,10390,9902,9845,10888,11902,8846,8957,10235,8210,5857)

testmae1 <- mae(actlfurn1,predfurn1)
testrmse1 <- rmse(actlfurn1,predfurn1)
testmape1 <- mape(actlfurn1,predfurn1)
testmase1 <- mase(actlfurn1,predfurn1)

# Visualize the MAIN evaluation Metrics
furniture_metrics3 <- data.frame(Metric = c("MAE", "RMSE"), Values = c((testmae1),(testrmse1)))
furniture_metrics3
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=furniture_metrics3, aes(x=Metric, y=Values, fill=Metric)) + geom_bar(stat="identity", position=position_dodge())

# Visualize the OTHER evaluation Metrics
furniture_metrics4 <- data.frame(Metric = c("MAPE", "MASE"), Values = c((testmape1),(testmase1)))
furniture_metrics4
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=furniture_metrics4, aes(x=Metric, y=Values, fill=Metric)) + geom_bar(stat="identity", position=position_dodge())



#----------------------------------------------------------------------------------------------------------------------------------||
#----------------------------------------------------------------------------------------------------------------------------------||



# AUTOARIMA MODEL
# --------------------->

library(TTR)
library(ggplot2)
library(forecast)   # install.packages("forecast", dependencies = TRUE)
library(sweep)      # Broom tidiers for forecast package
library(timetk)     # Working with time series in R


# Model for Forecasting retail retail sales

# Seasonally Adjusted data
retail <- c(4254,4342,4330,4359,4331,4401,4368,4372,4345,4299,4368,4428,4637,4507,4463,4564,4642,4609,4640,4645,4640,4663,4693,4693,4571,4775,4910,4916,4971,5018,5046,5165,5177,5260,5199,5254,5265,5081,5130,5181,5216,5217,5318,5304,5407,5429,5516,5445,5302,5346,5566,5595,5586,5678,5696,5655,5762,5779,5768,5746,5823,5847,5916,5968,6004,6034,6039,6146,6162,6154,6267,6290,6377,6342,6340,6369,6359,6426,6447,6444,6419,6504,6666,6687,6617,6767,6831,6794,6884,6986,6954,7147,7292,7324,7272,7246,7484,7548,7599,7729,7673,7593,7748,7682,7665,7737,7580,7160,7764,7611,7549,7560,7559,7613,7671,7628,7419,7543,7694,7869,7847,7932,7936,7874,7959,7831,7741,7837,7832,7789,7963,7927,7824,7501,7854,7895,8062,8084,8115,8156,8214,8244,8358,8312,8307,8375,8585,8519,8389,8572,8868,8675,8604,8806,8722,8905,8856,8908,8840,8994,8963,9093,9084,9193,9244,9315,9319,9260,9561,9439,9431,9402,9368,9485,9442,9422,9549,9375,9311,9334,9609,9369,9406,9430,9331,9264,9315,9300,9141,9142,9094,9009,8873,8594,8631,8606,8587,8473,8369,8154,7722,7735,7640,7460,7363,7285,7041,7067,7087,7092,7039,6991,6981,6915,6991,7024,7011,7123,7235,7121,7117,7072,7094,7130,7108,7039,7104,7062,6992,7145,7397,7321,7245,7227,7263,7333,7384,7303,7385,7530,7637,7627,7587,7510,7645,7552,7650,7600,7614,7416,7641,7959,7906,7850,7851,7814,7733,7956,7937,7982,8041,8140,8202,7913,7751,8048,8186,8297,8276,8287,8312,8447,8396,8407,8524,8656,8619,8424,8677,8788,8965,8796,8940,8977,8958,9036,9036,9227,9093,9134,9085,9068,9116,9262,9194,9172,9376,9225,9186,9111,9307,9322,9373,9266,9329,9381,9347,9420,9368,9614,9719,9723,9619,9686,9753,9941,9802,9810,9848,9732,9729,9739,9706,9660,9535,9651,9787,9853,9843,9854,9855,9881,9999,9916,9937,9746,10139,10133,7897,4071,7722)

# Not Seasonally Adjusted data
retail <- c(3846,3908,4157,4141,4275,4357,4407,4446,4328,4497,4687,5287,4104,3908,4369,4372,4535,4568,4682,4733,4621,4775,5158,5631,4018,4140,4827,4700,4867,4958,4980,5356,5203,5328,5734,6305,4649,4410,5084,4818,5195,5196,5190,5506,5418,5505,6090,6409,4788,4833,5410,5310,5603,5479,5673,5893,5589,5970,6425,6734,5311,5116,5715,5670,6010,5805,6027,6263,6094,6369,6781,7554,5822,5581,6162,6038,6225,6310,6466,6502,6329,6693,7186,8098,5922,5996,6790,6481,6684,6853,6961,7240,7139,7339,8006,8883,6638,6989,7622,7134,7635,7487,7508,7974,7535,7667,8346,8635,7050,6797,7572,6940,7551,7491,7456,7971,7078,7603,8548,9427,7149,7091,7777,7370,7991,7502,7671,8205,7456,7859,8839,9528,7190,6713,7618,7374,8078,7753,8074,8384,8017,8351,9018,10166,7651,7613,8499,7991,8112,8443,8895,8883,8441,8718,9594,10917,7908,7973,8787,8418,8649,8966,8957,9607,9216,9110,10232,11297,8595,8457,9412,8556,9209,9447,9244,9940,9511,9178,10195,11051,8802,8423,9415,8553,9266,9171,9194,9867,8885,9069,10012,10487,8163,8104,8381,8029,8604,8117,8495,8456,7676,7712,8121,8862,6796,6593,6907,6608,6974,6922,7194,7159,6967,6853,7375,8401,6324,6468,7271,6729,6932,6902,7243,7330,7101,6793,7630,8482,6244,6488,7530,6896,7086,7039,7241,7685,7450,6967,7931,9029,6866,7169,7784,6872,7683,7378,7551,8064,7439,7260,8260,9216,7297,7089,7875,7314,7834,7558,7977,8461,7848,8059,8842,9195,7201,7227,8104,7791,8384,7881,8403,8734,8371,8441,8950,10231,7964,7514,8616,8261,8893,8576,9110,9148,8967,9108,9488,10925,8175,8376,9258,8596,8988,9095,9157,9539,9498,9013,9903,10806,8255,8222,9626,8562,9394,9334,9207,9825,9471,9441,10487,11211,8686,8504,10016,9205,9949,9751,9740,10209,9573,9758,10579,10925,8648,8445,9846,9360,10069,9539,9944,10345,9839,9995,10782,11003,9257,9191,7881,3865,7202)


retail_sale <- ts(retail, start=c(1992, 1), frequency = 12)
retail_sale
plot(retail_sale)

# Decompose
retail.decadd <- decompose (retail_sale, type = "additive")
plot(retail.decadd)

# Seasonally Adjusting
retail_salecomponents <- decompose(retail_sale)
retail_saleseasonallyadjusted <- retail_sale - retail_salecomponents$seasonal
plot(retail_saleseasonallyadjusted)


# calculate the time series of first differences
# differences = 1
retail_sale_diff1 <- diff(retail_sale, differences = 1) 
retail_sale_diff1
plot.ts(retail_sale_diff1)
# differences = 2
retail_sale_diff2 <- diff(retail_sale, differences = 2) 
retail_sale_diff2
plot.ts(retail_sale_diff2)

# plot a correlogram
acf(retail_sale_diff1, lag.max=20)
acf(retail_sale_diff1, lag.max=20, plot=FALSE) # get the partial autocorrelation values

# plot a partial correlogram
pacf(retail_sale_diff1, lag.max=20)
pacf(retail_sale_diff1, lag.max=20, plot=FALSE) # get the partial autocorrelation values

retailsale_arima2 <- arima(retail_sale, order = c(0,1,2) )
retailsale_arima2
plot(forecast(retailsale_arima2,24))
# Summary
summary(retailsale_arima2)
retailsale_forecasts22 <- forecast(retailsale_arima2,24)
Box.test(retailsale_forecasts22$residuals, type = "Ljung-Box")

# USING AUTO-ARIMA
-------------------
retailsale_arima <- auto.arima(retail_sale, stepwise = FALSE)
retailsale_arima

# Make the forecast

# Method 1
retailsale_forecasts <- forecast:::forecast.Arima(retailsale_arima, h=24)
forecast:::plot.forecast(retailsale_forecasts)
# Method 2
forecast(retailsale_arima,24)
plot(forecast(retailsale_arima,24), xlab="Year", ylab = "Sales (Millions of Dollars)")
ppdd <- predict(retailsale_arima, n.ahead = 24)


# checking whether the predictive model could be improved 
acf(retailsale_forecasts$residuals)

# Check for P-value
Box.test(retailsale_forecasts$residuals, type = "Ljung-Box")

# Forescast errors
plot(retailsale_forecasts$residuals)

# Histogram of forecast Error
plotForecastErrors(retailsale_forecasts$residuals)

# Residuals from ARIMA
checkresiduals(retailsale_arima)

# Normal Q-Q plot
qqnorm(retailsale_arima$residuals)
qqline(retailsale_arima$residuals)

# Summary
summary(retailsale_arima)

# Evaluation Metrics
--------------------
tabularsales <- data.frame(summary(retailsale_arima))
View(tabularsales)

# Visualize the MAIN evaluation Metrics
retail_metrics <- data.frame(Metric = c("MAE", "RMSE"), Values = c((tabularsales$MAE),(tabularsales$RMSE)))
retail_metrics
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=retail_metrics, aes(x=Metric, y=Values, fill=Values)) + geom_bar(stat="identity", position=position_dodge())

# Visualize the OTHER evaluation Metrics
retail_metrics2 <- data.frame(Metric = c("MAPE", "MASE"), Values = c((tabularsales$MAPE),(tabularsales$MASE)))
retail_metrics2
# bar plot comparing metrics || Use position=position_dodge()
ggplot(data=retail_metrics2, aes(x=Metric, y=Values, fill=Metric)) + geom_bar(stat="identity", position=position_dodge())



#----------------------------------------------------------------------------------------------------------------------------------||
#----------------------------------------------------------------------------------------------------------------------------------||



# NeuralNetwork MODEL
# https://rdrr.io/cran/forecast/man/nnetar.html
# --------------------->

library(forecast)

fit <- nnetar(lynx)
fcast <- forecast(fit)
plot(fcast)

## Arguments can be passed to nnet()
fit <- nnetar(lynx, decay=0.5, maxit=150)
plot(forecast(fit))
lines(lynx)

## Fit model to first 100 years of lynx data
fit <- nnetar(window(lynx,end=1920), decay=0.5, maxit=150)
plot(forecast(fit,h=14))
lines(lynx)

## Apply fitted model to later data, including all optional arguments
fit2 <- nnetar(window(lynx,start=1921), model=fit)



#----------------------------------------------------------------------------------------------------------------------------------||
#----------------------------------------------------------------------------------------------------------------------------------||



# HYBRID ARIMA & ANN MODEL
# --------------------->

#Load Library
install.packages("neuralnet")
install.packages("nnfor")
library(hydroGOF)
library(ggplot2)
library(e1071)
library(neuralnet)
library(nnfor)
library(forecast)


# Read file
train <- read.csv('RSFHFS.csv')

attach(train)
train_ts=ts(train[,2], start=1, frequency = 12)
train_ann <- read.csv('RSFHFS.csv')
test <- read.csv('RSFHFS.csv')
plot(train_ts)

#Forecasting using ARIMA
arimasales <- auto.arima(retail_sale)
#arima <- arima(train[,2], order =c(0,1,4))
pred.arima <- predict(arimasales,n.ahead = 25)

extra <- data.frame(retailsale_forecasts$residuals)
View(extra)
colnames(extra)[1] <- "residuals"
#Calculated residuals
residuals <- train_ann[,2] - pred.arima$pred
residuals <- extra

# Train NN
# Data preprocessing
t3 = residuals[1:27]
t2 = residuals[2:28]
t1 = residuals[3:29]
result = residuals[4:30]
df = data.frame(t1,t2,t3,result)

# scale data from 0 to 1
maxs <- apply(df, 2, min)
mins <- apply(df, 2, min)
scaled.data <- as.data.frame(scale(df,center = mins, scale = maxs - mins))

#Training
feats <- names(scaled.data[1:3])
formula <- paste(feats,collapse='+')
formula <- paste('result ~',formula)
nn <- neuralnet (formula, scaled.data,hidden=2, linear.output=TRUE)
                 
# plot(nn)

#Continue forecasting ARIMA
pred.arima <- predict(arima,n.ahead=60)
pred.arima <- pred.arima$pred[31:60]

#Calculated Residuals
residuals_pre <- test[,2] - pred.arima;

# ann test

# Forecasting using NN
# Data preprocessing
t3 = c(tail(t2,n=1), tail(t1,n=1), tail(result,n=1), residuals_pre[1:27])
t2 = c(tail(t2,n=1), tail(result,n=1), residuals_pre[1:28])
t1 = c(tail(result,n=1), residuals_pre[1:29])
result = residuals_pre
df = data.frame(t1,t2,t3,result)

# scale data from 0 to 1
maxs <- apply(df, 2, min)
mins <- apply(df, 2, min)
scaled.data <- as.data.frame(scale(df,center = mins, scale = maxs - mins))

# Forecasting
pr.nn <- compute(nn,scaled.data[,1:3])

# Scale back
pred.nn <- pr.nn$net.resilt*(max(df$result)-min(df$result))+min(df$result)

# Combine two results
pred <- pred.arima + pred.nn[,1]
a=data.frame(pred)

#Measured
RMSE <- rmse(pred,test[,2]); RMSE
MAE <- mae(pred,test[,2]); MAE
MAPE <- mean(abs((test[,2] - pred)/test[,2])); MAPE



